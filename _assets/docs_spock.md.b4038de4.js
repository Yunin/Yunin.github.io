import{g as n,j as s,E as a,f as t,q as p}from"./common-eab4a3e3.js";const o='{"title":"Spock测试框架使用指北","frontmatter":{"date":"2021-05-31","title":"Spock测试框架使用指北","tags":["Java","Tool"],"describe":"基于Java和Groovy应用程序测试和规范框架,测试结果层次清晰，提供各种标签让编写测试代码更加高效和简洁,通用的，简单的，结构化的描述语言。"},"headers":[{"level":3,"title":"一、Spock是什么","slug":"一、spock是什么"},{"level":3,"title":"二、Spock，Junit，Jmock以及PowerMock区别","slug":"二、spock，junit，jmock以及powermock区别"},{"level":3,"title":"三、Spock项目引用配置","slug":"三、spock项目引用配置"},{"level":3,"title":"四、Spock 使用示例","slug":"四、spock-使用示例"},{"level":3,"title":"五、小结","slug":"五、小结"}],"relativePath":"docs/spock.md","lastUpdated":1622518904259.866}';var e={};const c=a('<p>[TOC]</p><h3 id="一、spock是什么"><a class="header-anchor" href="#一、spock是什么" aria-hidden="true">#</a> 一、Spock是什么</h3><ul><li>基于Java和Groovy应用程序测试和规范框架</li><li>测试结果层次清晰，提供各种标签让编写测试代码更加高效和简洁</li><li>通用的，简单的，结构化的描述语言</li></ul><p>官网描述：</p><blockquote><p>Spock is a testing and specification framework for Java and Groovy applications. What makes it stand out from the crowd is its beautiful and highly expressive specification language. Thanks to its JUnit runner, Spock is compatible with most IDEs, build tools, and continuous integration servers. Spock is inspired from JUnit, RSpec, jMock, Mockito, Groovy, Scala, Vulcans, and other fascinating life forms.</p></blockquote><p>Spock规范描述示例：</p><div class="language-java"><pre><code><span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">PowerMockRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>         <span class="token comment">// ------ 测试运行框架，支持静态类mock  ---|   Step 1</span>\n<span class="token annotation punctuation">@PowerMockRunnerDelegate</span><span class="token punctuation">(</span><span class="token class-name">Sputnik</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment">// --- 配合PowerMock 一起使用------------|</span>\n<span class="token annotation punctuation">@PrepareForTest</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">Test</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">)</span>           <span class="token comment">// --- 指明mock静态类--------------------|</span>\n<span class="token annotation punctuation">@PowerMockIgnore</span><span class="token punctuation">(</span><span class="token string">&quot;javax.management.*&quot;</span><span class="token punctuation">)</span>  <span class="token comment">// ------ 去掉一些报错信息  --------------|</span>\n<span class="token keyword">class</span> <span class="token class-name">TestSpec</span> <span class="token keyword">extends</span> <span class="token class-name">Specification</span> <span class="token punctuation">{</span>\n    def <span class="token string">&quot;DoTask&quot;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        given<span class="token operator">:</span> \t\t\t\t\t\t\t<span class="token comment">//---- Mock 准备： 数据mock，数据插桩 ----|   Step2</span>\n        <span class="token class-name">TestService</span> testService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TestService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token class-name">Test</span> client <span class="token operator">=</span> <span class="token class-name">Mock</span><span class="token punctuation">(</span><span class="token class-name">SeoPlatformManagerClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n        <span class="token class-name">PowerMockito</span><span class="token punctuation">.</span><span class="token function">mockStatic</span><span class="token punctuation">(</span><span class="token class-name">TestStatic</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n        <span class="token class-name">PowerMockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span><span class="token class-name">TestStatic</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>\n        client<span class="token punctuation">.</span><span class="token function">queryTags</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> responseType\n        when<span class="token operator">:</span>\t\t\t\t\t\t\t<span class="token comment">// --- 执行mock流程,获取mock运行结果--------| Step 3</span>\n        <span class="token class-name">TestResult</span> result<span class="token operator">=</span>testService<span class="token punctuation">.</span><span class="token function">doSomeThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        then<span class="token operator">:</span>\t\t\t\t\t\t\t<span class="token comment">// ----verify mock结果  -----------------| Step 4</span>\n        fligtCitesTimes <span class="token operator">*</span> result<span class="token punctuation">.</span>check\n        where<span class="token operator">:</span>                          <span class="token comment">// ----mock结果预期结果  -----------------| Step 5</span>\n        totalSize <span class="token operator">|</span> dataChangeLastTime <span class="token operator">|</span> tagList                                         <span class="token operator">||</span> fligtCitesTimes\n        <span class="token number">0</span>         <span class="token operator">|</span> <span class="token number">0L</span>                 <span class="token operator">|</span> <span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token operator">||</span> <span class="token number">0</span>\n        <span class="token number">1</span>         <span class="token operator">|</span> <span class="token number">1L</span>                 <span class="token operator">|</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TagDto</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">&quot;EN&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Test&quot;</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span>\n        <span class="token number">2</span>         <span class="token operator">|</span> <span class="token number">2L</span>                 <span class="token operator">|</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TagDto</span><span class="token punctuation">(</span><span class="token number">2L</span><span class="token punctuation">,</span> <span class="token string">&quot;EN&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Test&quot;</span><span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span>\n\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><h3 id="二、spock，junit，jmock以及powermock区别"><a class="header-anchor" href="#二、spock，junit，jmock以及powermock区别" aria-hidden="true">#</a> 二、Spock，Junit，Jmock以及PowerMock区别</h3><table><thead><tr><th></th><th>mock</th><th>静态mock</th><th>结构化</th><th>兼容groovy</th><th>IDEA支持</th></tr></thead><tbody><tr><td>Spock</td><td>支持</td><td>支持</td><td>语义层面定义测试流程</td><td>兼容</td><td>支持</td></tr><tr><td>Junit</td><td>不支持</td><td>不支持</td><td>顺序执行</td><td>不兼容</td><td>支持</td></tr><tr><td>Jmock/Mockito</td><td>支持</td><td>不支持</td><td>顺序执行</td><td>不兼容</td><td>不支持</td></tr><tr><td>PoweMock</td><td>支持</td><td>支持</td><td>顺序执行</td><td>不兼容</td><td>不支持</td></tr></tbody></table><h3 id="三、spock项目引用配置"><a class="header-anchor" href="#三、spock项目引用配置" aria-hidden="true">#</a> 三、Spock项目引用配置</h3><p>以Java项目，Maven 构建工具为例。</p><h4 id="_1-pom版本依赖"><a class="header-anchor" href="#_1-pom版本依赖" aria-hidden="true">#</a> 1. POM版本依赖</h4><div class="language-groovy"><pre><code><span class="token operator">&lt;</span>spock<span class="token punctuation">.</span>version<span class="token operator">&gt;</span><span class="token number">1.3</span><span class="token operator">-</span>groovy<span class="token operator">-</span><span class="token number">2.5</span><span class="token operator">&lt;</span><span class="token operator">/</span>spock<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>groovy<span class="token punctuation">.</span>version<span class="token operator">&gt;</span><span class="token number">2.5</span><span class="token punctuation">.</span><span class="token number">4</span><span class="token operator">&lt;</span><span class="token operator">/</span>groovy<span class="token punctuation">.</span>version<span class="token operator">&gt;</span>\n \n<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> spock <span class="token operator">--</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>spockframework<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spock<span class="token operator">-</span>core<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token punctuation">$</span><span class="token punctuation">{</span>spock<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>scope<span class="token operator">&gt;</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> spock和spring集成 <span class="token operator">--</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>spockframework<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spock<span class="token operator">-</span>spring<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token punctuation">$</span><span class="token punctuation">{</span>spock<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>scope<span class="token operator">&gt;</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> spock依赖的groovy <span class="token operator">--</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>groovy<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>groovy<span class="token operator">-</span>all<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>type<span class="token operator">&gt;</span>pom<span class="token operator">&lt;</span><span class="token operator">/</span>type<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token punctuation">$</span><span class="token punctuation">{</span>groovy<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>exclusions<span class="token operator">&gt;</span>\n        <span class="token operator">&lt;</span>exclusion<span class="token operator">&gt;</span>\n            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>groovy<span class="token operator">-</span>test<span class="token operator">-</span>junit5<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>\n            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>groovy<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>exclusion<span class="token operator">&gt;</span>\n        <span class="token operator">&lt;</span>exclusion<span class="token operator">&gt;</span>\n            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>groovy<span class="token operator">-</span>testng<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>\n            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>groovy<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>exclusion<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>exclusions<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>springframework<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring<span class="token operator">-</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>scope<span class="token operator">&gt;</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>\n \n<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>groovy 编译<span class="token operator">--</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>plugin<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org<span class="token punctuation">.</span>codehaus<span class="token punctuation">.</span>gmavenplus<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>gmavenplus<span class="token operator">-</span>plugin<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.6</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>executions<span class="token operator">&gt;</span>\n        <span class="token operator">&lt;</span>execution<span class="token operator">&gt;</span>\n            <span class="token operator">&lt;</span>goals<span class="token operator">&gt;</span>\n                <span class="token operator">&lt;</span>goal<span class="token operator">&gt;</span>compile<span class="token operator">&lt;</span><span class="token operator">/</span>goal<span class="token operator">&gt;</span>\n                <span class="token operator">&lt;</span>goal<span class="token operator">&gt;</span>compileTests<span class="token operator">&lt;</span><span class="token operator">/</span>goal<span class="token operator">&gt;</span>\n            <span class="token operator">&lt;</span><span class="token operator">/</span>goals<span class="token operator">&gt;</span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>execution<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>executions<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>plugin<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>添加spec的配置，测试用例必须以Spec结尾<span class="token operator">--</span><span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span>plugin<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>maven<span class="token operator">-</span>surefire<span class="token operator">-</span>plugin<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token punctuation">$</span><span class="token punctuation">{</span>surefire<span class="token punctuation">.</span>version<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span>configuration<span class="token operator">&gt;</span>\n        <span class="token operator">&lt;</span>includes<span class="token operator">&gt;</span>\n            <span class="token operator">&lt;</span>include<span class="token operator">&gt;</span><span class="token operator">**</span><span class="token comment">/*Spec.java&lt;/include&gt;\n            &lt;include&gt;**/</span><span class="token operator">*</span>Test<span class="token punctuation">.</span>java<span class="token operator">&lt;</span><span class="token operator">/</span>include<span class="token operator">&gt;</span>\n        <span class="token operator">&lt;</span><span class="token operator">/</span>includes<span class="token operator">&gt;</span>\n    <span class="token operator">&lt;</span><span class="token operator">/</span>configuration<span class="token operator">&gt;</span>\n<span class="token operator">&lt;</span><span class="token operator">/</span>plugin<span class="token operator">&gt;</span>\n</code></pre></div><blockquote><p><strong>Note</strong>:</p><ol><li>spock 版本是1.3-groovy-2.5。</li><li>Spock 2.x 的版本里官方团队已经移除Sputnik, 不再支持代理运行power mock。</li><li>Spock 2.0是基于JUnit5的, PowerMock尚不与JUnit 5兼容</li><li>项目中没有用过groovy，还需要添加groovy的maven编译插件，这样才能编译spock的单测代码。</li></ol></blockquote><h4 id="_2-新建测试用例"><a class="header-anchor" href="#_2-新建测试用例" aria-hidden="true">#</a> 2. 新建测试用例</h4><div class="language-"><pre><code>project\n│\n└───src\n│   │   main\n│   └───test\n│       │   groovy // ---groovy的约定，是默认编译groovy包下的单测，需要建个groovy包存放spock的单测代码\n│       │   java   // ---java测试单例目录\n│       │   resources\n</code></pre></div><blockquote><p><strong>Note:</strong></p><ol><li>标记groovy目录为测试源目录(IDEA 工具 Test Sources Root)</li><li>groovy创建单测文件groovy class ,非java class.</li></ol></blockquote><h4 id="_3-执行单元测试"><a class="header-anchor" href="#_3-执行单元测试" aria-hidden="true">#</a> 3. 执行单元测试</h4><p>mvn test，按照上面两步的配置保证spock单测代码运行成功后可以执行mvn clean test命令</p><blockquote><p><strong>NOTE</strong>:</p><p>按照spock的规范来说，单测代码文件的命名应该是以Spec为后缀的，如果你严格按照这个规范</p><p>命名单测文件，比如“TestSpec”.</p></blockquote><h3 id="四、spock-使用示例"><a class="header-anchor" href="#四、spock-使用示例" aria-hidden="true">#</a> 四、Spock 使用示例</h3><h4 id="_1-第三方依赖"><a class="header-anchor" href="#_1-第三方依赖" aria-hidden="true">#</a> 1. 第三方依赖</h4><p>第三方代码示例：</p><div class="language-java"><pre><code><span class="token class-name">Class</span> <span class="token class-name">ThirdParty</span><span class="token punctuation">{</span>\n\t<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">R</span> r<span class="token punctuation">)</span><span class="token punctuation">{</span>\n\t\t<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>项目代码使用场景</p><div class="language-"><pre><code>@Component\nClass ThirdPartyDemo{\n\t@Autowired\n\tprivate ThirdParty thirdParty;\n\t\n\tpublic T doSomething(R r){\n\t\tT t=thirdParty.call(r);\n\t\t.....\n\t}\n\t\n}\n</code></pre></div><p>测试用例</p><div class="language-"><pre><code>class ThirdPartyDemoSpec extends Specification {\n    def &quot;DoSomeThing&quot;() {\n        given:\n        ThirdPartyDemo testService = new ThirdPartyDemo()\n        ThirdParty thirdParty = Mock(ThirdParty.class);\n        T t = Mock(T.class);\n        R r = Mock(R.class)\n        PowerMockito.when(thirdParty.call(_)).thenReturn(t)\n        t.something -&gt; ttt\n        when:\n        TestResult result = testService.doSomeThing(r)\n        then:\n        result * result.check\n        where:\n        ttt   || result\n        test  || true\n        test2 || false\n    }\n}\n</code></pre></div><blockquote><p><strong>Note</strong>:</p><p><strong>1. given</strong>: 输入条件(前置参数)</p><p><strong>2. when</strong>: 执行行为(mock接口, 真实调用)</p><p><strong>3. then</strong>: 输出条件(验证结果)</p><p><strong>4. where</strong>:预期结果</p><p>5 . <code>thirdParty.call(_)</code> 中的<code>_</code> 代表任意条件</p><p>6 . <code>t.something -&gt; ttt</code> 中的 <code>-&gt; </code> 代表mock过程，当然PowerMock 还是采用 when . thenReturn 方式</p></blockquote><h4 id="_2-多分支场景"><a class="header-anchor" href="#_2-多分支场景" aria-hidden="true">#</a> 2. 多分支场景</h4><p>多分支方代码示例：</p><div class="language-java"><pre><code><span class="token class-name">Class</span> <span class="token class-name">ThirdParty</span><span class="token punctuation">{</span>\n\t<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">R</span> r<span class="token punctuation">)</span><span class="token punctuation">{</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>something<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n            <span class="token keyword">return</span> a<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n        <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>something<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n            <span class="token keyword">return</span> b<span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n         <span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>something<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{</span>\n             <span class="token keyword">return</span> c<span class="token punctuation">;</span>\n         <span class="token punctuation">}</span>\n\t\t<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>项目代码使用场景</p><div class="language-"><pre><code>@Component\nClass ThirdPartyDemo{\n\t@Autowired\n\tprivate ThirdParty thirdParty;\n\t\n\tpublic T doSomething(R r){\n\t\tT t=thirdParty.call(r);\n\t\t.....\n\t}\n\t\n}\n</code></pre></div><p>测试用例</p><div class="language-"><pre><code>class ThirdPartyMultiConditionDemoSpec extends Specification {\n    def &quot;DoSomeThing&quot;() {\n        given:\n        ThirdPartyDemo testService = new ThirdPartyDemo()\n        ThirdParty thirdParty = Mock(ThirdParty.class);\n        T t = Mock(T.class);\n        R r = Mock(R.class)\n        PowerMockito.when(thirdParty.call(_)).thenReturn(t)\n        r.something -&gt; ttt\n        when:\n        TestResult result = testService.doSomeThing(r)\n        then:\n        result * result.check\n        where:\n        ttt   || result\n        1  || true\n        2 || false\n        3 || false\n    }\n}\n</code></pre></div><blockquote><p><strong>Note</strong>:</p><p><strong>where</strong>: 输入预期结果是一个Table，能够覆盖多个分支</p></blockquote><h4 id="_3-静态类mock"><a class="header-anchor" href="#_3-静态类mock" aria-hidden="true">#</a> 3. 静态类MOCK</h4><p>静态代码示例：</p><div class="language-java"><pre><code><span class="token class-name">Class</span> <span class="token class-name">StaticClass</span><span class="token punctuation">{</span>\n\t<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">T</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token class-name">R</span> r<span class="token punctuation">)</span><span class="token punctuation">{</span>\n\t\t<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\t<span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre></div><p>项目代码使用场景</p><div class="language-java"><pre><code><span class="token annotation punctuation">@Component</span>\n<span class="token class-name">Class</span> <span class="token class-name">StaticClassDemo</span><span class="token punctuation">{</span>\n\t\n\t<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token class-name">R</span> r<span class="token punctuation">)</span><span class="token punctuation">{</span>\n\t\t<span class="token class-name">T</span> t<span class="token operator">=</span><span class="token class-name">StaticClass</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\t\t<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>\n\t<span class="token punctuation">}</span>\n\t\n<span class="token punctuation">}</span>\n</code></pre></div><p>测试用例</p><div class="language-java"><pre><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>ibu<span class="token punctuation">.</span>nlp<span class="token punctuation">.</span>service<span class="token punctuation">.</span>soa<span class="token punctuation">.</span>service<span class="token punctuation">.</span>seo</span>\n\n\n<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>ibu<span class="token punctuation">.</span>seo<span class="token punctuation">.</span>platform<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>contract<span class="token punctuation">.</span></span><span class="token class-name">QueryTagsResponseType</span>\n<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>ibu<span class="token punctuation">.</span>seo<span class="token punctuation">.</span>platform<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>contract<span class="token punctuation">.</span></span><span class="token class-name">SeoPlatformManagerClient</span>\n<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>ctrip<span class="token punctuation">.</span>ibu<span class="token punctuation">.</span>seo<span class="token punctuation">.</span>platform<span class="token punctuation">.</span>admin<span class="token punctuation">.</span>contract<span class="token punctuation">.</span></span><span class="token class-name">TagDto</span>\n<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">Lists</span>\n<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>runner<span class="token punctuation">.</span></span><span class="token class-name">RunWith</span>\n<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>powermock<span class="token punctuation">.</span>api<span class="token punctuation">.</span>mockito<span class="token punctuation">.</span></span><span class="token class-name">PowerMockito</span>\n<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>powermock<span class="token punctuation">.</span>core<span class="token punctuation">.</span>classloader<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">PowerMockIgnore</span>\n<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>powermock<span class="token punctuation">.</span>core<span class="token punctuation">.</span>classloader<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">PrepareForTest</span>\n<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>powermock<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">PowerMockRunner</span>\n<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>powermock<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>junit4<span class="token punctuation">.</span></span><span class="token class-name">PowerMockRunnerDelegate</span>\n<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>spockframework<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">Sputnik</span>\n<span class="token keyword">import</span> <span class="token namespace">spock<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span><span class="token class-name">Specification</span>\n\n<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">PowerMockRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@PowerMockRunnerDelegate</span><span class="token punctuation">(</span><span class="token class-name">Sputnik</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@PrepareForTest</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token class-name">StaticClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">)</span>\n<span class="token annotation punctuation">@PowerMockIgnore</span><span class="token punctuation">(</span><span class="token string">&quot;javax.management.*&quot;</span><span class="token punctuation">)</span>\n<span class="token keyword">class</span> <span class="token class-name">StaticClassDemoSpec</span> <span class="token keyword">extends</span> <span class="token class-name">Specification</span> <span class="token punctuation">{</span>\n    def <span class="token string">&quot;DoSomeThing&quot;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        given<span class="token operator">:</span>\n        <span class="token class-name">PowerMockito</span><span class="token punctuation">.</span><span class="token function">mockStatic</span><span class="token punctuation">(</span><span class="token class-name">StaticClass</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n        <span class="token class-name">T</span> t <span class="token operator">=</span> <span class="token class-name">Mock</span><span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token class-name">R</span> r <span class="token operator">=</span> <span class="token class-name">Mock</span><span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>\n        <span class="token class-name">PowerMockito</span><span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span><span class="token class-name">StaticClass</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenReturn</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>\n        t<span class="token punctuation">.</span>something <span class="token operator">-&gt;</span> ttt\n        when<span class="token operator">:</span>\n        <span class="token class-name">TestResult</span> result <span class="token operator">=</span> testService<span class="token punctuation">.</span><span class="token function">doSomeThing</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>\n        then<span class="token operator">:</span>\n        result <span class="token operator">*</span> result<span class="token punctuation">.</span>check\n        where<span class="token operator">:</span>\n        ttt   <span class="token operator">||</span> result\n        test  <span class="token operator">||</span> <span class="token boolean">true</span>\n        test2 <span class="token operator">||</span> <span class="token boolean">false</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre></div><blockquote><p><strong>Note</strong>:</p><ol><li>@PowerMockRunnerDelegate(Sputnik.class)交给spock代理执行</li><li>@PrepareForTest([StaticClass.class]) 指定需要执行的静态类</li><li>结合PoweMock 实现静态类mock</li></ol></blockquote><h4 id="_4-void-方法测试"><a class="header-anchor" href="#_4-void-方法测试" aria-hidden="true">#</a> 4. void 方法测试</h4><p>第三方代码</p><div class="language-"><pre><code>Class ThirdParty{\n\tpublic void call(R r){\n\t\t.....\n\t}\n}\n</code></pre></div><p>项目代码使用场景</p><div class="language-"><pre><code>@Component\nClass ThirdPartyDemo{\n@Autowired\n\tprivate ThirdParty thirdParty;\n\tpublic T doSomething(R r){\n\t\t thirdParty.call(r);\n\t\t.....\n\t}\n\t\n}\n</code></pre></div><p>测试用例</p><div class="language-"><pre><code>class ThirdPartyDemoExceptionSpec extends Specification {\n    def &quot;DoSomeThing&quot;() {\n        given:\n        ThirdPartyDemo testService = new ThirdPartyDemo()\n        ThirdParty thirdParty = Mock(ThirdParty.class);\n        T t = Mock(T.class);\n        R r = Mock(R.class)\n        PowerMockito.when(thirdParty.call(_)).thenReturn(t)\n        t.something -&gt; ttt\n        \n        when:\n        testService.doSomeThing(r)\n        then:\n       1*thirdParty.call(r)\n    }\n}\n</code></pre></div><blockquote><p><strong>Note</strong>:</p><p>then 标签里直接标明throw exception ，并且指定exception类型，以及校验异常信息</p></blockquote><h4 id="_5-异常情况用法"><a class="header-anchor" href="#_5-异常情况用法" aria-hidden="true">#</a> 5. 异常情况用法</h4><p>项目代码使用场景</p><div class="language-"><pre><code>@Component\nClass ThirdPartyDemo{\n\n\tpublic void doSomething(R r){\n\t\t.....\n\t}\n\t\n}\n</code></pre></div><p>测试用例</p><div class="language-"><pre><code>class ThirdPartyVoidSpec extends Specification {\n    def &quot;DoSomeThing&quot;() {\n        given:\n        ThirdPartyDemo testService = new ThirdPartyDemo()\n        ThirdParty thirdParty = Mock(ThirdParty.class);\n        T t = Mock(T.class);\n        R r = Mock(R.class)\n        PowerMockito.when(thirdParty.call(_)).thenReturn(t)\n        t.something -&gt; ttt\n        testService.doSomeThing(r)\n        when:\n        def ex = thrown(expectedException)\n        then:\n        ex.message == expectedMessage\n        where:\n        ttt   | expectedException || expectedMessage\n        test  | APIExeption       || &quot;Request is null&quot;\n        test2 | APIExeption       || &quot;ttt is null&quot;\n    }\n}\n</code></pre></div><blockquote><p><strong>Note</strong>:</p><p><code>1*thirdParty.call(r)</code> 中 1 代表执行的次数， 二“*” 代表条件相等</p></blockquote><h3 id="五、小结"><a class="header-anchor" href="#五、小结" aria-hidden="true">#</a> 五、小结</h3><h4 id="_1-spock的优点"><a class="header-anchor" href="#_1-spock的优点" aria-hidden="true">#</a> 1. spock的优点</h4><ul><li><p>遵循BDD模式、功能强大、语义规范、可读性好、易于维护、富有表现力</p></li><li><p>更灵活的控制测试行为，专注代码的逻辑测试而不是书写语法上</p></li><li><p>用自然语言描述测试步骤（非技术人员也能看懂测试用例）</p></li><li><p>兼容mock框架，可以和项目中的java单测代码共存, 降低迁移成本</p></li><li><p>IDE支持良好</p></li><li><p>Groovy动态语言，DSL，语法简洁，约定优于配置，适合敏捷开发</p></li></ul><h4 id="_2-spock的缺点"><a class="header-anchor" href="#_2-spock的缺点" aria-hidden="true">#</a> 2. spock的缺点</h4><h5 id="_1-学习成本"><a class="header-anchor" href="#_1-学习成本" aria-hidden="true">#</a> 1.学习成本</h5><p>spock本身没什么学习成本，因为它的限制条件不多：必须有至少一个标签、有when必有then...</p><p>主要是groovy语言，如果用过的会觉得很容易，其实真的很容易，只要你会java，就会groovy！</p><p>groovy还有一个特点就是你可以在spock的单测代码里完全用java代码写，因为groovy完全兼容java语法，</p><p>或者java和groovy混着写都没问题，因为最终都是编译成class执行的，JVM虚拟机不关心源文件是什么语言。</p><p>(其实groovy的用途很广,像我们的Jenkins里的pipeline, Elasticsearch, hadoop框架中很多插件都是使用groovy开发的)</p><h5 id="_2-单测代码执行时间问题"><a class="header-anchor" href="#_2-单测代码执行时间问题" aria-hidden="true">#</a> 2.单测代码执行时间问题</h5><p>groovy语法的简洁可以简单理解为语法糖(其实不完全是，在jvm中执行使用的是invokeDynamic指令)，</p><p>语法糖会相应的增加jvm构建AST语法树的时间，大家在运行的时候可能会注意到spock代码的编译</p><p><strong>要比java的单测代码慢一些</strong>(视代码复杂度而言，平均大概慢1-2s)，但是执行的时间和java的差不多，</p><p>如果对这个有要求，<strong>慎重使用</strong>, 最好自己实际验证下</p><h5 id="_3-spock不支持java的静态-final方法的mock-关于这一点在上面第三章已经讲过"><a class="header-anchor" href="#_3-spock不支持java的静态-final方法的mock-关于这一点在上面第三章已经讲过" aria-hidden="true">#</a> 3. Spock不支持Java的静态,final方法的mock, 关于这一点在上面第三章已经讲过,</h5><p>因为官网的解释不能马上解决目前我们单测的现状, 所以再引入power mock,</p><p>不过大部分项目组应该都使用过power mock</p><p>另外，有时候你觉得你的代码很难写单元测试，说明代码写的不是很好，需要去关注代码本身的逻辑，设计是否合理，</p><p>一步步去重构你的代码，让你的代码变得容易测试。因为<strong>代码的可测试性也是一个衡量代码质量的很重要的标准!</strong></p><p>spock只是个工具，如果用它都无法解决你的单测case, 那我觉得应该把更多的注意力放在被测代码的设计上</p><p>当然肯定也有spock无法解决的场景, 只不过使用spock相对其他工具而言会轻松很多。</p><p>Spock不能保证让你爱上写单测, 但至少不会让你反感 ☺</p>',82);e.render=function(a,o,e,r,l,k){const u=p("Comment");return t(),n("div",null,[c,s(u)])};export default e;export{o as __pageData};
